#!/usr/bin/env bash
POKY_SDK_PATH='/home/build/opt/poky/3.0'
CURRENT_DIR="$(dirname $(readlink -f $0))"
LAYERS_DIR="layers"
RECIPES_IK_DIR="$LAYERS_DIR/custom/meta-ik/recipes-images"

if [ 1 -ne $# ]; then
    echo 'Need build_dir_path'
    exit 0
fi

BUILD_DIR="${CURRENT_DIR}/${1}"
cd "${LAYERS_DIR}"
source syncAll.sh 'zeus'
cd "${CURRENT_DIR}"
echo "--- Prepare build workspace ---"
echo "source $POKY_SDK_PATH/environment-setup-x86_64-pokysdk-linux"
echo "source /home/build/layers/internet/poky/oe-init-build-env ${1}"

cd "${RECIPES_IK_DIR}"
for item in *; do
    if [ -f $item ]; then
        name=${item%.*}
        extension=${item##*.}
        if [[ 'bb' == $extension  ]]; then
            echo ""
            echo "--- Configuration: ${name} ---"
            echo "cp -fv ${PWD}/${name}-bblayers.conf ${BUILD_DIR}/conf/bblayers.conf"
            echo "cp -fv ${PWD}/${name}-local.conf ${BUILD_DIR}/conf/local.conf"
            echo "bitbake -c build virtual/kernel"
            echo "bitbake $name && bitbake $name -c populate_sdk"
        fi
    fi
done
